package main

import (
	"io"
	"text/template"
)

type tmplData struct {
	PackageName string
	ApiVersion  string
	Fieldsets   []fieldsetDesc
}

var tmpl = `
// Code generated by generate_fieldsetmap. DO NOT EDIT.

package {{ .PackageName }}

// FieldsetFn returns the procedure used to produce a resource's fieldset.
type FieldsetFn interface {
	Prefix() string
	Fields(_ Resource) map[string]string
}

// LookupFieldsetFn is used to dynamically look up fieldset func for given typename
func LookupFieldsetFn(typename string) (FieldsetFn, bool) {
	fset, ok := fieldsetMap[typename]
	return fset, ok
}

type fieldsetDesc struct {
    prefix string
    fields func(_ Resource) map[string]string
}

func (f *fieldsetDesc) Prefix() string {
    return f.prefix
}

func (f *fieldsetDesc) Fields(v Resource) map[string]string {
    return f.fields(v)
}

// fieldsetMap is used to dynamically look up fieldset func for given type
var fieldsetMap = map[string]FieldsetFn{ {{ range $index, $field := .Fieldsets }}
	"{{ $field.Kind }}": &fieldsetDesc{
		prefix: "{{ $field.Prefix }}",
		fields:  {{ $field.Name }},
	},
	{{ end }}
}
`

func executeTemplate(wr io.Writer, data tmplData) error {
	t, err := template.New("fieldset").Parse(tmpl)
	if err != nil {
		return err
	}
	return t.Execute(wr, data)
}
